#include <stdio.h>
#include <stdlib.h>
#include <libusb-1.0/libusb.h>

// The bRequest we send
#define SET_REPORT 0x09

// The structure of the REPORTs we send to the device
struct report {
	uint16_t length;
	char data[32];
};


// This Report yields a reply that changes in few places every second
// (probably a timestamp, uptime, battery charge level or similar)
struct report COMMAND_TIMESTAMP = { .length = 28, .data = {
		0x09, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
};

struct report reports_list[] = {
	{ .length = 17, .data = {
		0x01, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00}
	},
	{ .length = 17, .data = {
		0x01, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	// This one yields a longer reply
	{ .length = 28, .data = {
		0x09, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x0a, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x0d, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x05, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x0c, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x0e, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x01, 0x00, 0x3f, 0x30, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	{ .length = 28, .data = {
		0x09, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00}
	},
	// Sentinel for the end of the array
	{ .length = -1, .data = {} }
};



void iserror(char* where, int what) {
	if (what != 0) {
		printf("%s error %d %s\n", where, what, libusb_error_name(what));
		exit(-1);
	}
}


char* send_report_and_get_reply(libusb_device_handle* h, uint16_t length,
		char* data) {
	uint8_t bmRequestType = LIBUSB_REQUEST_TYPE_CLASS | LIBUSB_RECIPIENT_INTERFACE; // 0x21
	uint16_t wValue = 0x0209; // ID 9, Type 2 (output)
	int transferred;
	char reply[65536];
	int r = 0; // to collect return values
	r = libusb_control_transfer(h, bmRequestType, SET_REPORT,
			wValue, 0, data, length, 0);
	//iserror("ctrl xfer", r);
	//printf("ctrl xferred %d bytes\n", r);

	r = libusb_interrupt_transfer(h, 0x82, reply, sizeof(reply),
			&transferred, 0);
	iserror("intr xfer", r);
	//printf("intr xferred %d bytes\n", transferred);
	return data;
}


// Send the full "magic sequence" that we sniffed from RÃ˜DE Central
void send_magic_sequence(libusb_device_handle* h) {
	for (int i=0; reports_list[i].length != (uint16_t)-1; i++) {
		struct report rtbl = reports_list[i];
		send_report_and_get_reply(h, rtbl.length, rtbl.data);
	}
}



int main(int argc, char* argv) {
	libusb_device_handle* h;
	libusb_context* ctx = NULL; // use default context for now
	int r=0; // to catch various return values
	

	int i=0;

	r = libusb_init(&ctx);
	iserror("init", r);
	r = libusb_set_option(ctx, LIBUSB_OPTION_LOG_LEVEL,
			LIBUSB_LOG_LEVEL_WARNING);
	iserror("set opt", r);

	h = libusb_open_device_with_vid_pid(
			ctx, (uint16_t)0x19f7, (uint16_t)0x002d);
	iserror("open dev", h==NULL);

	if (libusb_kernel_driver_active(h, 0)) {
		libusb_detach_kernel_driver(h, 0);
	}

	/*
	send_report_and_get_reply(h, COMMAND_TIMESTAMP.length,
			COMMAND_TIMESTAMP.data);
	*/
	send_magic_sequence(h);

	libusb_attach_kernel_driver(h, 0);
	libusb_close(h);
	libusb_exit(ctx);
	
	return 0;
}
